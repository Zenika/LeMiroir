<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>MARCEL v2</title>
  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="bower_components/polymer/polymer.html">
  <link rel="import" href="css/shared-styles.html">
  <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="css/weather-icons.min.css">
  <link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body onload="loadComponents()">

  <div id="error_container">
    <div id="error">
    </div>
  </div>
  <section id="components"></section>

  <script src="bower_components/polymer-application-loader/loader.js"></script>
  <script>
    const loader = new PolymerApplicationLoader()
    let loaded = false

    function launchLoad(config) {
      const { mediaId, backendURL, pluginURL } = config
      return loader.load(
        'components',
        `http://${backendURL}/medias/${mediaId}`,
        `http://${pluginURL}/medias/${mediaId}/plugins`,
      ).then(media => ({ ...config, media }))
    }

    function openNotificationConnection(config) {
      const { backendURL, mediaId, media } = config
      if (!media.isactive) {
        setTimeout(() => window.location.reload(), 30000)
        throw "This Media is not active.\n You can activate it in the back-office.\n\nThis media will be reloaded in 30 seconds."
      }

      const conn = new WebSocket(`ws://${backendURL}/medias/${mediaId}/notifier`)

      conn.onmessage = ({ data }) => {
        if (data === 'update') {
          showError("This media has been updated.\n\n It will be reloaded in a few seconds...")
          setTimeout(() => window.location.reload(), 5000)
        }
      }

      conn.onopen = () => hideError()

      conn.onclose = event => {
        setTimeout(() => openNotificationConnection(config), 10000)
        showError("Connection with backend has been lost.\nTrying to reconnect in a few seconds...")
      }

      window.onbeforeunload = () => conn.close()
    }

    function showError(error) {
      document.querySelector("#error").innerText = error
      document.querySelector("#error_container").style.visibility = "visible"
    }

    function hideError() {
      document.querySelector("#error_container").style.visibility = "hidden"
    }

    function loadComponents() {
      if (loaded) return
      loaded = true

      fetch('conf/config.json')
        .then(res => res.json())
        .then(res => [res.backendURL || 'localhost', res.pluginURL || 'localhost'])
        .catch(() => ['localhost', 'localhost'])
        .then(ips => {
          const urlParts = window.location.href.split('/')
          if (urlParts.length !== 4 || !urlParts[3]) throw "No media id specified.\n\nPlease specify one at the end of the current URL."

          return { mediaId: urlParts[3], backendURL: ips[0], pluginURL: ips[1] }
        })
        .then(launchLoad)
        .then(openNotificationConnection)
        .catch(error => {
          document.querySelector("#components").style.visibility = "hidden"
          showError(error)
        })
    }
  </script>
</body>

</html>