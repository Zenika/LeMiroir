<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>MARCEL v2</title>
  <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="bower_components/polymer/polymer.html">
  <link rel="import" href="css/shared-styles.html">
  <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="css/weather-icons.min.css">
  <style>
    body {
      background-color: var(--background-color);
      color: var(--primary-color);
      overflow-y: hidden;
    }
  </style>
</head>

<body onload="loadComponents()">
  <section id="components"></section>
  <script src="bower_components/polymer-application-loader/loader.js"></script>
  <script>
    const loader = new PolymerApplicationLoader()
    let loaded = false

    function launchLoad(config) {
      const { mediaId, backendURL, pluginURL } = config
      loader.load(
        'components',
        `${backendURL}/medias/${mediaId}`,
        `${pluginURL}/medias/${mediaId}/plugins`,
      )

    function openNotificationConnection(config) {
      const { backendURL, mediaId } = config

      const conn = new WebSocket(`ws://${backendURL}/medias/${mediaId}/notifier`)

      conn.onmessage = ({ data }) => {
        if (data === 'update') {
          setTimeout(() => window.location.reload(), 5000)
        }
      }

      conn.onopen = () => hideError()

      conn.onclose = event => {
        setTimeout(() => openNotificationConnection(config), 10000)
      }

      window.onbeforeunload = () => conn.close()
    }

    function loadComponents() {
      if (loaded) return
      loaded = true

      fetch('conf/config.json')
        .then(res => res.json())
        .then(res => [res.backendURL || 'localhost', res.pluginURL || 'localhost'])
        .catch(() => ['localhost', 'localhost'])
        .then(ips => {
          const urlParts = window.location.href.split('/')
          if (urlParts.length !== 4 || !urlParts[3]) throw "Bad URL"

          return { mediaId: urlParts[3], backendURL: ips[0], pluginURL: ips[1] }
        })
        .then(launchLoad)
        .then(openNotificationConnection)
        .catch(error => {
          document.getElementById("components").innerText = JSON.stringify(error)
        })
    }
  </script>
</body>

</html>