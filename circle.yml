machine:
  node:
    version: 8.0.0
  services:
    - docker
  post: 
    - npm install -g yarn
    - npm install -g bower
    #- npm install -g polymer-cli
  environment:
    PATH: "$PATH:~/MARCEL/back-office/node_modules/.bin"

dependencies:
  pre: 
    #- rm -rf ~/.go_workspace/src/github.com/Zenika
    #- mkdir -p ~/.go_workspace/src/github.com/Zenika
    #- ln -s MARCEL ~/.go_workspace/src/github.com/Zenika/MARCEL
  override:
    - yarn:
        pwd: back-office
    - bower install:
        pwd: frontend
    #- ./install_go_deps.sh
    #  pwd: scripts
  cache_directories:
    - ~/.cache/yarn

compile:
  override:
    - yarn build:
        pwd: back-office
    #- polymer build:
    #    pwd: frontend
    #- go install:
    #    pwd: ~/.go_workspace/src/github.com/Zenika/MARCEL/backoffice

test:
  override:
    - yarn test:
        pwd: back-office
    #- go test .
    #    pwd: ~/.go_workspace/src/github.com/Zenika/MARCEL/backoffice

deployment:
  pre:
    - docker build -t marcel-back-office .:
        pwd: back-office
    - docker save -o marcel-back-office.tar marcel-back-office
    - docker build -t marcel-frontend .:
        pwd: frontend
    - docker save -o marcel-frontend.tar marcel-frontend
    - echo $INTEGRATION_SERVER_KEY | sed s/retourligne/\\n/g > integration_key.pem
    - chmod 400 integration_key.pem
  override:
    - scp -i integration_key.pem marcel-back-office.tar marcel-frontend.tar ubuntu@35.158.222.144:~/
    - ssh -i integration_key.pem ubuntu@35.158.222.144 "./MARCEL/deploy.sh"
  post:
    - rm -f integration_key.pem
    - mv *.tar $CIRCLE_ARTIFACTS