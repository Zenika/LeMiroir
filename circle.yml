machine:
  node:
    version: 8.0.0
  services:
    - docker
  post:
    - docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD -e $DOCKER_EMAIL
    - npm install -g yarn
    # - npm install -g bower
    #- npm install -g polymer-cli
  environment:
    PATH: "$PATH:~/MARCEL/back-office/node_modules/.bin"

checkout:
  post:
    - git submodule sync
    - git submodule update --init

dependencies:
  pre:
    - rm -rf ~/.go_workspace/src/github.com/Zenika
    - mkdir -p ~/.go_workspace/src/github.com/Zenika
    - ln -s `pwd` ~/.go_workspace/src/github.com/Zenika/MARCEL
  override:
    - yarn:
        pwd: back-office
    - yarn:
        pwd: frontend
    - ./install_go_deps.sh:
        pwd: scripts
  cache_directories:
    - ~/.cache/yarn

compile:
  override:
    - yarn build:
        pwd: back-office
    - yarn build:
        pwd: frontend
    - CGO_ENABLED=0 go build -a -installsuffix cgo -o backend .:
        pwd: ../.go_workspace/src/github.com/Zenika/MARCEL/backend
    - CGO_ENABLED=0 go build -a -installsuffix cgo -o auth-backend .:
        pwd: ../.go_workspace/src/github.com/Zenika/MARCEL/auth-backend
    # Packaging plugins
    - tar -czf plugins.tar.gz plugins

test:
  override:
    - yarn test:
        pwd: back-office
    - go test .:
        pwd: ../.go_workspace/src/github.com/Zenika/MARCEL/backend

deployment:
  dev:
    branch: dev
    commands:
      # Exporting serveur key
      - echo $INTEGRATION_SERVER_KEY | sed s/retourligne/\\n/g > integration_key.pem
      - chmod 400 integration_key.pem

      # Packaging backoffice
      - docker build -t zenika/marcel-backoffice:dev .:
          pwd: back-office

      # Packaging frontend
      - docker build -t zenika/marcel-frontend:dev .:
          pwd: frontend

      # Packaging backend
      - docker build -t zenika/marcel-backend:dev .:
          pwd: ../.go_workspace/src/github.com/Zenika/MARCEL/backend

      # Packaging auth-backend
      - docker build -t zenika/marcel-auth:dev .:
          pwd: ../.go_workspace/src/github.com/Zenika/MARCEL/auth-backend

      # Pushing docker images
      - docker push zenika/marcel-backoffice:dev
      - docker push zenika/marcel-backend:dev
      - docker push zenika/marcel-frontend:dev
      - docker push zenika/marcel-auth:dev

      # Uploading packages
      - scp -i integration_key.pem plugins.tar.gz ubuntu@35.158.222.144:~/
      - scp -i integration_key.pem docker-compose.yml ubuntu@35.158.222.144:~/

      # Running deployement script
      - ssh -i integration_key.pem ubuntu@35.158.222.144 "./MARCEL/deploy.sh"

      # Cleaning up
      - rm -f integration_key.pem
  production:
    branch: master
    tag: /v.*/
    commands:
      # Packaging back-office
      - docker build -t zenika/marcel-backoffice .:
          pwd: back-office

      # Packaging front-end
      - docker build -t zenika/marcel-frontend .:
          pwd: frontend

      # Packaging back-end
      - docker build -t zenika/marcel-backend .:
          pwd: ../.go_workspace/src/github.com/Zenika/MARCEL/backend

      # Add tag for each image
      - docker tag zenika/marcel-backoffice zenika/marcel-backoffice:$CIRCLE_TAG
      - docker tag zenika/marcel-backend zenika/marcel-backend:$CIRCLE_TAG
      - docker tag zenika/marcel-frontend zenika/marcel-frontend:$CIRCLE_TAG

      # Pushing docker images to docker Hub
      - docker push zenika/marcel-backoffice
      - docker push zenika/marcel-backend
      - docker push zenika/marcel-frontend